// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  // Optimize for serverless environments
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  // Use DATABASE_URL for pooled connections (runtime)
  url       = env("DATABASE_URL")
  // Use DIRECT_URL for direct connections (migrations)
  // This is especially important for Supabase where:
  // - DATABASE_URL uses port 6543 (PgBouncer pooler)
  // - DIRECT_URL uses port 5432 (direct connection)
  // For other providers where pooling is automatic (like Neon),
  // DIRECT_URL is optional and can be the same as DATABASE_URL
  // Falls back to DATABASE_URL if DIRECT_URL is not set (development)
  directUrl = env("DIRECT_URL")
}

// Enums
enum OrderStatus {
  pending
  paid
  confirmed
  processing
  packed
  picked_up
  in_transit
  out_for_delivery
  fulfilled
  shipped
  delivered
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum VendorStatus {
  pending
  approved
  rejected
  suspended
}

enum NotificationType {
  order
  payment
  vendor
  promotion
  system
}

enum DiscountType {
  percentage
  fixed_amount
  free_shipping
}

enum CouponStatus {
  active
  inactive
  expired
  depleted
}

enum PromotionType {
  product_discount
  category_discount
  cart_discount
  buy_x_get_y
}

enum UserRole {
  customer
  vendor
  admin
}

enum ContractStatus {
  draft
  pending_signature
  active
  expired
  terminated
  renewed
}

enum FeedbackType {
  bug
  feature_request
  improvement
  usability
  performance
  other
}

enum FeedbackStatus {
  new
  under_review
  planned
  in_progress
  completed
  rejected
}

enum FeedbackPriority {
  low
  medium
  high
  critical
}

enum ContractType {
  standard
  premium
  enterprise
  custom
}

enum SignatureStatus {
  pending
  signed
  rejected
}

// Models
model User {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                  String    @unique
  password               String
  role                   UserRole  @default(customer)
  emailVerified          DateTime? @map("email_verified")
  emailVerificationToken String?   @map("email_verification_token")
  passwordResetToken     String?   @map("password_reset_token")
  passwordResetExpiry    DateTime? @map("password_reset_expiry")
  loginAttempts          Int       @default(0) @map("login_attempts")
  lockoutUntil           DateTime? @map("lockout_until")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  profile                 Profile?
  orders                  Order[]
  reviews                 Review[]
  wishlists               Wishlist[]
  couponUsages            CouponUsage[]
  notificationPreferences NotificationPreference?
  preferences             UserPreferences?
  loyaltyAccount          LoyaltyAccount?
  referralsGiven          Referral[]              @relation("Referrer")
  referralsReceived       Referral[]              @relation("Referee")
  giftCardsPurchased      GiftCard[]              @relation("GiftCardPurchaser")
  giftCardsReceived       GiftCard[]              @relation("GiftCardRecipient")
  sellerRatings           SellerRating[]
  disputes                Dispute[]
  comparisons             ProductComparison[]
  emailSubscriptions      EmailSubscription[]
  premiumSubscription     PremiumSubscription?
  productSubscriptions    ProductSubscription[]
  savedSearches           SavedSearch[]
  priceAlerts             PriceAlert[]
  viewHistory             ViewHistory[]
  // New: Next-gen features
  recommendationScores    RecommendationScore[]
  customerChats           ChatConversation[]      @relation("CustomerChats")
  vendorChats             ChatConversation[]      @relation("VendorChats")
  adminChats              ChatConversation[]      @relation("AdminChats")
  chatMessages            ChatMessage[]
  voiceSearches           VoiceSearch[]
  groupPurchasesInitiated GroupPurchase[]         @relation("GroupPurchaseInitiator")
  groupPurchaseMembers    GroupPurchaseMember[]
  socialShares            SocialShare[]
  equbCirclesCreated      EqubCircle[]            @relation("EqubCircleCreator")
  equbCircleMembers       EqubCircleMember[]
  equbDistributions       EqubDistribution[]
  autoReorderRules        AutoReorderRule[]
  purchaseOrders          PurchaseOrder[]
  achievements            UserAchievement[]
  dailyCheckIns           DailyCheckIn[]
  gameScores              GameScore[]
  flashSaleRegistrations  FlashSaleRegistration[]
  betaFeedback            BetaFeedback[]
  betaTester              BetaTester?
  announcementReads       FeatureAnnouncementRead[]

  @@map("users")
}

model Profile {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String       @unique @map("user_id") @db.Uuid
  displayName    String?      @map("display_name")
  firstName      String?      @map("first_name")
  lastName       String?      @map("last_name")
  phone          String?
  address        String?
  city           String?
  country        String?
  postalCode     String?      @map("postal_code")
  avatarUrl      String?      @map("avatar_url")
  bio            String?
  isVendor       Boolean      @default(false) @map("is_vendor")
  vendorStatus   VendorStatus @default(pending) @map("vendor_status")
  tradeLicense   String?      @map("trade_license")
  tinNumber      String?      @map("tin_number")
  commissionRate Decimal?     @default(0.15) @map("commission_rate") @db.Decimal(5, 4)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  products         Product[]
  orderItems       OrderItem[]
  vendorPayouts    VendorPayout[]
  vendorStatements VendorStatement[]
  addresses        Address[]
  sellerRatings    SellerRating[]
  disputes         Dispute[]
  productShares    ProductShare[]
  vendorContracts  VendorContract[]

  @@map("profiles")
}

model Address {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId    String   @map("profile_id") @db.Uuid
  label        String // e.g., "Home", "Work", "Office"
  fullName     String   @map("full_name")
  phone        String
  addressLine1 String   @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String
  state        String?
  postalCode   String?  @map("postal_code")
  country      String   @default("ET")
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model Category {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?  @map("image_url")
  parentId    String?  @map("parent_id") @db.Uuid
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId          String   @map("vendor_id") @db.Uuid
  categoryId        String?  @map("category_id") @db.Uuid
  name              String
  slug              String   @unique
  brand             String?
  description       String?
  shortDescription  String?  @map("short_description")
  price             Decimal  @db.Decimal(10, 2)
  salePrice         Decimal? @map("sale_price") @db.Decimal(10, 2)
  sku               String?  @unique
  stockQuantity     Int      @default(0) @map("stock_quantity")
  lowStockThreshold Int      @default(5) @map("low_stock_threshold")
  weight            Decimal? @db.Decimal(8, 2)
  dimensions        Json?
  images            Json     @default("[]")
  features          Json     @default("[]")
  specifications    Json     @default("{}")
  isDigital         Boolean  @default(false) @map("is_digital")
  isFeatured        Boolean  @default(false) @map("is_featured")
  isActive          Boolean  @default(true) @map("is_active")
  metaTitle         String?  @map("meta_title")
  metaDescription   String?  @map("meta_description")
  ratingAverage     Decimal  @default(0) @map("rating_average") @db.Decimal(3, 2)
  ratingCount       Int      @default(0) @map("rating_count")
  viewCount         Int      @default(0) @map("view_count")
  saleCount         Int      @default(0) @map("sale_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  vendor               Profile                @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  category             Category?              @relation(fields: [categoryId], references: [id])
  variants             ProductVariant[]
  carts                Cart[]
  orderItems           OrderItem[]
  reviews              Review[]
  wishlists            Wishlist[]
  tieredPricing        TieredPricing[]
  flashSales           FlashSale[]
  reservations         InventoryReservation[]
  media                Media[]
  productSubscriptions ProductSubscription[]
  priceAlerts          PriceAlert[]
  shares               ProductShare[]
  viewHistory          ViewHistory[]
  // New: Next-gen features
  recommendationScores RecommendationScore[]
  chatConversations    ChatConversation[]
  groupPurchases       GroupPurchase[]
  socialShares         SocialShare[]
  inventoryForecasts   InventoryForecast[]
  autoReorderRules     AutoReorderRule[]
  liveStockCounters    LiveStockCounter[]

  @@map("products")
}

model ProductVariant {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String   @map("product_id") @db.Uuid
  name          String
  price         Decimal? @db.Decimal(10, 2)
  salePrice     Decimal? @map("sale_price") @db.Decimal(10, 2)
  sku           String?  @unique
  stockQuantity Int      @default(0) @map("stock_quantity")
  weight        Decimal? @db.Decimal(8, 2)
  dimensions    Json?
  attributes    Json     @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  product              Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  carts                Cart[]
  orderItems           OrderItem[]
  reservations         InventoryReservation[]
  productSubscriptions ProductSubscription[]

  @@map("product_variants")
}

model Cart {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  sessionId String?  @map("session_id")
  productId String   @map("product_id") @db.Uuid
  variantId String?  @map("variant_id") @db.Uuid
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("carts")
}

model Order {
  id                     String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                 String?       @map("user_id") @db.Uuid
  orderNumber            String        @unique @map("order_number")
  status                 OrderStatus   @default(pending)
  paymentStatus          PaymentStatus @default(pending) @map("payment_status")
  paymentMethod          String?       @map("payment_method")
  paymentReference       String?       @map("payment_reference")
  stripeSessionId        String?       @map("stripe_session_id")
  subtotal               Decimal       @db.Decimal(10, 2)
  shippingAmount         Decimal       @default(0) @map("shipping_amount") @db.Decimal(10, 2)
  taxAmount              Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount         Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount            Decimal       @map("total_amount") @db.Decimal(10, 2)
  currency               String        @default("ETB")
  shippingAddress        Json?         @map("shipping_address")
  billingAddress         Json?         @map("billing_address")
  notes                  String?
  // Warehouse origin for delivery
  warehouseId            String?       @map("warehouse_id") @db.Uuid
  // Buyer Protection fields
  buyerProtectionEnabled Boolean       @default(false) @map("buyer_protection_enabled")
  protectionFee          Decimal       @default(0) @map("protection_fee") @db.Decimal(10, 2)
  protectionExpiresAt    DateTime?     @map("protection_expires_at")
  insuranceEnabled       Boolean       @default(false) @map("insurance_enabled")
  insuranceFee           Decimal       @default(0) @map("insurance_fee") @db.Decimal(10, 2)
  shippingDeadline       DateTime?     @map("shipping_deadline")
  paidAt                 DateTime?     @map("paid_at")
  confirmedAt            DateTime?     @map("confirmed_at")
  processingAt           DateTime?     @map("processing_at")
  packedAt               DateTime?     @map("packed_at")
  pickedUpAt             DateTime?     @map("picked_up_at")
  inTransitAt            DateTime?     @map("in_transit_at")
  outForDeliveryAt       DateTime?     @map("out_for_delivery_at")
  fulfilledAt            DateTime?     @map("fulfilled_at")
  shippedAt              DateTime?     @map("shipped_at")
  deliveredAt            DateTime?     @map("delivered_at")
  cancelledAt            DateTime?     @map("cancelled_at")
  refundedAt             DateTime?     @map("refunded_at")
  // Enhanced delivery tracking fields
  estimatedDeliveryStart DateTime?     @map("estimated_delivery_start")
  estimatedDeliveryEnd   DateTime?     @map("estimated_delivery_end")
  deliveryProofUrl       String?       @map("delivery_proof_url")
  deliveryNotes          String?       @map("delivery_notes")
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")

  user                 User?                 @relation(fields: [userId], references: [id])
  orderItems           OrderItem[]
  reviews              Review[]
  orderEvents          OrderEvent[]
  couponId             String?               @map("coupon_id") @db.Uuid
  coupon               Coupon?               @relation(fields: [couponId], references: [id])
  promotionIds         Json                  @default("[]") @map("promotion_ids")
  shippingZoneId       String?               @map("shipping_zone_id") @db.Uuid
  shippingZone         ShippingZone?         @relation(fields: [shippingZoneId], references: [id])
  shippingMethodId     String?               @map("shipping_method_id") @db.Uuid
  shippingMethod       ShippingMethod?       @relation(fields: [shippingMethodId], references: [id])
  couponUsages         CouponUsage[]
  refunds              Refund[]
  invoice              Invoice?
  giftCardTransactions GiftCardTransaction[]
  sellerRatings        SellerRating[]
  disputes             Dispute[]
  subscriptionOrders   SubscriptionOrder[]
  protectionClaims     ProtectionClaim[]
  deliveryTracking     DeliveryTracking?
  warehouse            Warehouse?            @relation("WarehouseOrders", fields: [warehouseId], references: [id])
  // New: Next-gen features
  chatConversations    ChatConversation[]
  groupPurchaseMembers GroupPurchaseMember[]

  @@index([warehouseId])
  @@map("orders")
}

model OrderEvent {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String       @map("order_id") @db.Uuid
  eventType   String       @map("event_type")
  status      OrderStatus?
  description String?
  metadata    Json?
  createdAt   DateTime     @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_events")
}

// Enhanced Delivery Tracking for real-time delivery visibility
model DeliveryTracking {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId                String    @unique @map("order_id") @db.Uuid
  // Logistics Provider Integration
  logisticsProvider      String?   @map("logistics_provider")
  providerTrackingId     String?   @map("provider_tracking_id")
  providerWebhookEnabled Boolean   @default(false) @map("provider_webhook_enabled")
  // Courier Information
  courierName            String?   @map("courier_name")
  courierPhone           String?   @map("courier_phone")
  courierPhotoUrl        String?   @map("courier_photo_url")
  courierVehicleInfo     String?   @map("courier_vehicle_info")
  // GPS Tracking (where available)
  currentLatitude        Decimal?  @map("current_latitude") @db.Decimal(10, 8)
  currentLongitude       Decimal?  @map("current_longitude") @db.Decimal(11, 8)
  lastLocationUpdate     DateTime? @map("last_location_update")
  locationHistory        Json      @default("[]") @map("location_history")
  // Delivery Window
  estimatedDeliveryStart DateTime? @map("estimated_delivery_start")
  estimatedDeliveryEnd   DateTime? @map("estimated_delivery_end")
  actualDeliveryTime     DateTime? @map("actual_delivery_time")
  // Delivery Proof
  deliveryProofPhotoUrl  String?   @map("delivery_proof_photo_url")
  deliverySignatureUrl   String?   @map("delivery_signature_url")
  deliveryNotes          String?   @map("delivery_notes")
  recipientName          String?   @map("recipient_name")
  // SMS Notification Tracking
  smsNotificationsSent   Json      @default("[]") @map("sms_notifications_sent")
  // Traffic and Route Information
  routeData              Json?     @map("route_data") // Stores route geometry, waypoints
  trafficConditions      Json?     @map("traffic_conditions") // Traffic data from API
  estimatedDistanceKm    Decimal?  @map("estimated_distance_km") @db.Decimal(8, 2)
  estimatedDurationMin   Int?      @map("estimated_duration_min")
  trafficDelayMin        Int?      @default(0) @map("traffic_delay_min")
  lastRouteUpdate        DateTime? @map("last_route_update")
  // Metadata
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([logisticsProvider])
  @@index([providerTrackingId])
  @@map("delivery_tracking")
}

model WebhookEvent {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider      String
  eventId       String?   @map("event_id")
  orderId       String?   @map("order_id") @db.Uuid
  signature     String?
  signatureHash String?   @map("signature_hash")
  payload       Json
  status        String    @default("received")
  createdAt     DateTime  @default(now()) @map("created_at")
  processedAt   DateTime? @map("processed_at")
  ipAddress     String?   @map("ip_address")
  latencyMs     Int?      @map("latency_ms")
  errorMessage  String?   @map("error_message")
  retryCount    Int       @default(0) @map("retry_count")
  nextRetryAt   DateTime? @map("next_retry_at")
  archived      Boolean   @default(false)

  @@unique([provider, eventId])
  @@map("webhook_events")
}

model OrderItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  vendorId    String   @map("vendor_id") @db.Uuid
  productId   String?  @map("product_id") @db.Uuid
  variantId   String?  @map("variant_id") @db.Uuid
  productName String   @map("product_name")
  productSku  String?  @map("product_sku")
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  order   Order           @relation(fields: [orderId], references: [id])
  vendor  Profile         @relation(fields: [vendorId], references: [id])
  product Product?        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model Review {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  productId    String   @map("product_id") @db.Uuid
  orderId      String?  @map("order_id") @db.Uuid
  rating       Int
  title        String?
  comment      String?
  images       Json     @default("[]")
  helpfulCount Int      @default(0) @map("helpful_count")
  isVerified   Boolean  @default(false) @map("is_verified")
  isApproved   Boolean  @default(true) @map("is_approved")
  reportCount  Int      @default(0) @map("report_count")
  reportedBy   Json     @default("[]") @map("reported_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  order   Order?  @relation(fields: [orderId], references: [id])

  @@map("reviews")
}

model Wishlist {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("wishlists")
}

model ViewHistory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  viewedAt  DateTime @default(now()) @map("viewed_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId, viewedAt])
  @@map("view_history")
}

model Notification {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  @@map("notifications")
}

model VendorPayout {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String    @map("vendor_id") @db.Uuid
  periodStart      DateTime  @map("period_start")
  periodEnd        DateTime  @map("period_end")
  totalSales       Decimal   @map("total_sales") @db.Decimal(10, 2)
  commissionRate   Decimal   @default(0.15) @map("commission_rate") @db.Decimal(5, 4)
  commissionAmount Decimal   @map("commission_amount") @db.Decimal(10, 2)
  payoutAmount     Decimal   @map("payout_amount") @db.Decimal(10, 2)
  status           String    @default("pending")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  vendor     Profile           @relation(fields: [vendorId], references: [id])
  statements VendorStatement[]

  @@map("vendor_payouts")
}

model AnalyticsEvent {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  sessionId String?  @map("session_id")
  eventType String   @map("event_type")
  eventData Json?    @map("event_data")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("analytics_events")
}

model Coupon {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String       @unique
  description     String?
  discountType    DiscountType @map("discount_type")
  discountValue   Decimal      @map("discount_value") @db.Decimal(10, 2)
  minimumPurchase Decimal?     @map("minimum_purchase") @db.Decimal(10, 2)
  maximumDiscount Decimal?     @map("maximum_discount") @db.Decimal(10, 2)
  usageLimit      Int?         @map("usage_limit")
  usageCount      Int          @default(0) @map("usage_count")
  perUserLimit    Int?         @map("per_user_limit")
  startsAt        DateTime?    @map("starts_at")
  expiresAt       DateTime?    @map("expires_at")
  status          CouponStatus @default(active)
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  orders       Order[]
  couponUsages CouponUsage[]

  @@index([status])
  @@index([expiresAt])
  @@map("coupons")
}

model CouponUsage {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  couponId       String   @map("coupon_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  orderId        String   @map("order_id") @db.Uuid
  discountAmount Decimal  @map("discount_amount") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@map("coupon_usage")
}

model Promotion {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  description     String?
  promotionType   PromotionType @map("promotion_type")
  discountType    DiscountType  @map("discount_type")
  discountValue   Decimal       @map("discount_value") @db.Decimal(10, 2)
  productIds      Json          @default("[]") @map("product_ids")
  categoryIds     Json          @default("[]") @map("category_ids")
  minimumQuantity Int?          @map("minimum_quantity")
  minimumPurchase Decimal?      @map("minimum_purchase") @db.Decimal(10, 2)
  buyQuantity     Int?          @map("buy_quantity")
  getQuantity     Int?          @map("get_quantity")
  isActive        Boolean       @default(true) @map("is_active")
  startsAt        DateTime      @map("starts_at")
  endsAt          DateTime?     @map("ends_at")
  priority        Int           @default(0)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([startsAt, endsAt])
  @@map("promotions")
}

model TieredPricing {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String       @map("product_id") @db.Uuid
  minQuantity   Int          @map("min_quantity")
  maxQuantity   Int?         @map("max_quantity")
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("tiered_pricing")
}

model FlashSale {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  description   String?
  productId     String       @map("product_id") @db.Uuid
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  originalPrice Decimal      @map("original_price") @db.Decimal(10, 2)
  flashPrice    Decimal      @map("flash_price") @db.Decimal(10, 2)
  stockLimit    Int?         @map("stock_limit")
  stockSold     Int          @default(0) @map("stock_sold")
  startsAt      DateTime     @map("starts_at")
  endsAt        DateTime     @map("ends_at")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  product           Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  // New: Next-gen features
  registrations     FlashSaleRegistration[]
  liveStockCounters LiveStockCounter[]

  @@index([productId])
  @@index([startsAt, endsAt])
  @@map("flash_sales")
}

model ShippingZone {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  countries   Json     @default("[\"ET\"]")
  regions     Json     @default("[]")
  cities      Json     @default("[]")
  postalCodes Json     @default("[]") @map("postal_codes")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  shippingRates ShippingRate[]
  orders        Order[]

  @@map("shipping_zones")
}

model ShippingMethod {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  description      String?
  carrier          String?
  estimatedDaysMin Int?     @map("estimated_days_min")
  estimatedDaysMax Int?     @map("estimated_days_max")
  isActive         Boolean  @default(true) @map("is_active")
  sortOrder        Int      @default(0) @map("sort_order")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  shippingRates ShippingRate[]
  orders        Order[]

  @@map("shipping_methods")
}

model ShippingRate {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  zoneId                String   @map("zone_id") @db.Uuid
  methodId              String   @map("method_id") @db.Uuid
  baseRate              Decimal  @map("base_rate") @db.Decimal(10, 2)
  perKgRate             Decimal? @map("per_kg_rate") @db.Decimal(10, 2)
  freeShippingThreshold Decimal? @map("free_shipping_threshold") @db.Decimal(10, 2)
  minOrderAmount        Decimal? @map("min_order_amount") @db.Decimal(10, 2)
  maxOrderAmount        Decimal? @map("max_order_amount") @db.Decimal(10, 2)
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  zone   ShippingZone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  method ShippingMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)

  @@index([zoneId, methodId])
  @@map("shipping_rates")
}

model TaxRate {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  rate        Decimal  @db.Decimal(5, 4)
  country     String   @default("ET")
  region      String?
  city        String?
  taxType     String   @default("VAT") @map("tax_type")
  isCompound  Boolean  @default(false) @map("is_compound")
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([country, region, city])
  @@index([isActive])
  @@map("tax_rates")
}

model InventoryReservation {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId  String    @map("product_id") @db.Uuid
  variantId  String?   @map("variant_id") @db.Uuid
  quantity   Int
  userId     String?   @map("user_id") @db.Uuid
  sessionId  String?   @map("session_id")
  orderId    String?   @map("order_id") @db.Uuid
  status     String    @default("active")
  expiresAt  DateTime  @map("expires_at")
  releasedAt DateTime? @map("released_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([userId])
  @@index([sessionId])
  @@index([orderId])
  @@index([status, expiresAt])
  @@map("inventory_reservations")
}

model Refund {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId          String    @map("order_id") @db.Uuid
  amount           Decimal   @db.Decimal(10, 2)
  reason           String?
  status           String    @default("pending")
  provider         String?
  providerRefundId String?   @map("provider_refund_id")
  processedAt      DateTime? @map("processed_at")
  failedAt         DateTime? @map("failed_at")
  failureReason    String?   @map("failure_reason")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("refunds")
}

model Invoice {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String    @unique @map("order_id") @db.Uuid
  invoiceNumber  String    @unique @map("invoice_number")
  issueDate      DateTime  @map("issue_date")
  dueDate        DateTime? @map("due_date")
  subtotal       Decimal   @db.Decimal(10, 2)
  taxAmount      Decimal   @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  shippingAmount Decimal   @default(0) @map("shipping_amount") @db.Decimal(10, 2)
  totalAmount    Decimal   @map("total_amount") @db.Decimal(10, 2)
  currency       String    @default("ETB")
  status         String    @default("draft")
  pdfUrl         String?   @map("pdf_url")
  emailSentAt    DateTime? @map("email_sent_at")
  paidAt         DateTime? @map("paid_at")
  notes          String?
  tinNumber      String?   @map("tin_number")
  tradeLicense   String?   @map("trade_license")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

model VendorStatement {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String    @map("vendor_id") @db.Uuid
  payoutId         String?   @map("payout_id") @db.Uuid
  statementNumber  String    @unique @map("statement_number")
  periodStart      DateTime  @map("period_start")
  periodEnd        DateTime  @map("period_end")
  totalSales       Decimal   @map("total_sales") @db.Decimal(10, 2)
  commissionAmount Decimal   @map("commission_amount") @db.Decimal(10, 2)
  payoutAmount     Decimal   @map("payout_amount") @db.Decimal(10, 2)
  pdfUrl           String?   @map("pdf_url")
  emailSentAt      DateTime? @map("email_sent_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  vendor Profile       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  payout VendorPayout? @relation(fields: [payoutId], references: [id])

  @@index([vendorId])
  @@index([payoutId])
  @@map("vendor_statements")
}

model Media {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId         String   @map("product_id") @db.Uuid
  url               String
  altText           String?  @map("alt_text")
  size              Int
  width             Int?
  height            Int?
  format            String
  optimizedVersions Json     @default("{}") @map("optimized_versions")
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("media")
}

model NotificationPreference {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String   @unique @map("user_id") @db.Uuid
  emailOrderConfirm   Boolean  @default(true) @map("email_order_confirm")
  emailShippingUpdate Boolean  @default(true) @map("email_shipping_update")
  emailPromotions     Boolean  @default(false) @map("email_promotions")
  emailNewsletter     Boolean  @default(false) @map("email_newsletter")
  inAppOrderUpdates   Boolean  @default(true) @map("inapp_order_updates")
  inAppPromotions     Boolean  @default(true) @map("inapp_promotions")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model EmailQueue {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  to            String
  subject       String
  html          String
  text          String
  template      String?
  metadata      Json?
  status        String    @default("pending") // pending, processing, sent, failed
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  lastError     String?   @map("last_error")
  lastAttemptAt DateTime? @map("last_attempt_at")
  sentAt        DateTime? @map("sent_at")
  scheduledFor  DateTime? @map("scheduled_for")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([status, scheduledFor])
  @@index([createdAt])
  @@map("email_queue")
}

model CommissionLedger {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String    @map("vendor_id") @db.Uuid
  orderId          String    @map("order_id") @db.Uuid
  orderItemId      String?   @map("order_item_id") @db.Uuid
  saleAmount       Decimal   @map("sale_amount") @db.Decimal(10, 2)
  commissionRate   Decimal   @map("commission_rate") @db.Decimal(5, 4)
  commissionAmount Decimal   @map("commission_amount") @db.Decimal(10, 2)
  vendorPayout     Decimal   @map("vendor_payout") @db.Decimal(10, 2)
  status           String    @default("pending")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@index([vendorId])
  @@index([orderId])
  @@index([status])
  @@index([paidAt])
  @@map("commission_ledger")
}

model SiteSettings {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  maintenanceMode    Boolean  @default(false) @map("maintenance_mode")
  maintenanceMessage String?  @map("maintenance_message")
  featuredProducts   Json?    @map("featured_products")
  homepageBanners    Json?    @map("homepage_banners")
  announcementBar    Json?    @map("announcement_bar")
  allowNewVendors    Boolean  @default(true) @map("allow_new_vendors")
  allowNewCustomers  Boolean  @default(true) @map("allow_new_customers")
  minOrderAmount     Decimal  @default(0) @map("min_order_amount") @db.Decimal(10, 2)
  maxOrderAmount     Decimal  @default(1000000) @map("max_order_amount") @db.Decimal(10, 2)
  defaultCurrency    String   @default("ETB") @map("default_currency")
  defaultLanguage    String   @default("en") @map("default_language")
  taxRate            Decimal  @default(0.15) @map("tax_rate") @db.Decimal(5, 4)
  shippingEnabled    Boolean  @default(true) @map("shipping_enabled")
  emailNotifications Boolean  @default(true) @map("email_notifications")
  smsNotifications   Boolean  @default(false) @map("sms_notifications")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

// User Preferences for language and other settings
model UserPreferences {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @unique @map("user_id") @db.Uuid
  language       String   @default("en")
  currency       String   @default("ETB")
  emailMarketing Boolean  @default(true) @map("email_marketing")
  smsMarketing   Boolean  @default(false) @map("sms_marketing")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// Loyalty Program
enum LoyaltyTier {
  bronze
  silver
  gold
  platinum
}

model LoyaltyAccount {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String      @unique @map("user_id") @db.Uuid
  points         Int         @default(0)
  lifetimePoints Int         @default(0) @map("lifetime_points")
  tier           LoyaltyTier @default(bronze)
  nextTierPoints Int         @default(1000) @map("next_tier_points")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions LoyaltyTransaction[]

  @@map("loyalty_accounts")
}

model LoyaltyTransaction {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId   String    @map("account_id") @db.Uuid
  points      Int // positive for earn, negative for redeem
  type        String // purchase, review, referral, redeem, bonus
  description String
  relatedId   String?   @map("related_id") @db.Uuid // orderId, reviewId, etc.
  createdAt   DateTime  @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")

  account LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([createdAt])
  @@map("loyalty_transactions")
}

// Referral Program
enum ReferralStatus {
  pending
  registered
  completed
  expired
}

model Referral {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  referrerId   String         @map("referrer_id") @db.Uuid
  refereeId    String?        @map("referee_id") @db.Uuid
  code         String         @unique
  status       ReferralStatus @default(pending)
  rewardIssued Boolean        @default(false) @map("reward_issued")
  createdAt    DateTime       @default(now()) @map("created_at")
  completedAt  DateTime?      @map("completed_at")
  expiresAt    DateTime       @map("expires_at")

  referrer User  @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  User? @relation("Referee", fields: [refereeId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([referrerId])
  @@index([status])
  @@map("referrals")
}

// Gift Cards
enum GiftCardStatus {
  active
  redeemed
  expired
  cancelled
}

model GiftCard {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String         @unique
  purchaserId    String         @map("purchaser_id") @db.Uuid
  recipientId    String?        @map("recipient_id") @db.Uuid
  recipientEmail String?        @map("recipient_email")
  amount         Decimal        @db.Decimal(10, 2)
  balance        Decimal        @db.Decimal(10, 2)
  status         GiftCardStatus @default(active)
  message        String?
  expiresAt      DateTime       @map("expires_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  redeemedAt     DateTime?      @map("redeemed_at")

  purchaser    User                  @relation("GiftCardPurchaser", fields: [purchaserId], references: [id], onDelete: Cascade)
  recipient    User?                 @relation("GiftCardRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  transactions GiftCardTransaction[]

  @@index([code])
  @@index([status])
  @@map("gift_cards")
}

model GiftCardTransaction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cardId    String   @map("card_id") @db.Uuid
  orderId   String?  @map("order_id") @db.Uuid
  amount    Decimal  @db.Decimal(10, 2)
  type      String // purchase, redeem, refund
  createdAt DateTime @default(now()) @map("created_at")

  card  GiftCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  order Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([cardId])
  @@map("gift_card_transactions")
}

// Seller Ratings
model SellerRating {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId        String   @map("vendor_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  orderId         String   @map("order_id") @db.Uuid
  communication   Int // 1-5
  shippingSpeed   Int      @map("shipping_speed") // 1-5
  accuracy        Int // 1-5
  customerService Int      @map("customer_service") // 1-5
  overallRating   Decimal  @map("overall_rating") @db.Decimal(3, 2) // calculated average
  comment         String?
  createdAt       DateTime @default(now()) @map("created_at")

  vendor Profile @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  order  Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, userId])
  @@index([vendorId])
  @@map("seller_ratings")
}

// Dispute Resolution
enum DisputeType {
  not_received
  not_as_described
  damaged
  wrong_item
  refund_issue
  other
}

enum DisputeStatus {
  open
  pending_vendor_response
  pending_admin_review
  resolved
  closed
}

model Dispute {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId             String        @map("order_id") @db.Uuid
  orderItemIds        String[]      @default([]) @map("order_item_ids") @db.Uuid // For multi-item disputes
  userId              String        @map("user_id") @db.Uuid
  vendorId            String        @map("vendor_id") @db.Uuid
  type                DisputeType
  description         String
  evidenceUrls        String[]      @map("evidence_urls")
  videoEvidenceUrls   String[]      @default([]) @map("video_evidence_urls") // Video evidence support
  status              DisputeStatus @default(open)
  resolution          String?
  resolvedBy          String?       @map("resolved_by") @db.Uuid
  resolvedAt          DateTime?     @map("resolved_at")
  refundProcessed     Boolean       @default(false) @map("refund_processed")
  refundAmount        Float?        @map("refund_amount")
  refundTransactionId String?       @map("refund_transaction_id")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  order    Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor   Profile          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  messages DisputeMessage[]

  @@index([status])
  @@index([userId])
  @@index([vendorId])
  @@index([createdAt])
  @@index([resolvedAt])
  @@map("disputes")
}

model DisputeMessage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  disputeId String   @map("dispute_id") @db.Uuid
  senderId  String   @map("sender_id") @db.Uuid
  message   String
  isAdmin   Boolean  @default(false) @map("is_admin")
  createdAt DateTime @default(now()) @map("created_at")

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@map("dispute_messages")
}

// Product Comparison
model ProductComparison {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  productIds String[] @map("product_ids") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("product_comparisons")
}

// Vendor Verification System
enum VerificationStatus {
  pending
  under_review
  approved
  rejected
  suspended
}

model VendorVerification {
  id                     String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId               String             @unique @map("vendor_id") @db.Uuid
  tradeLicenseUrl        String?            @map("trade_license_url")
  tradeLicenseNumber     String?            @map("trade_license_number")
  tinCertificateUrl      String?            @map("tin_certificate_url")
  tinNumber              String?            @map("tin_number")
  businessRegUrl         String?            @map("business_reg_url")
  ownerIdUrl             String?            @map("owner_id_url")
  ocrVerified            Boolean            @default(false) @map("ocr_verified")
  ocrVerificationData    Json?              @map("ocr_verification_data")
  govApiVerified         Boolean            @default(false) @map("gov_api_verified")
  govApiVerificationData Json?              @map("gov_api_verification_data")
  status                 VerificationStatus @default(pending)
  rejectionReason        String?            @map("rejection_reason")
  reviewedBy             String?            @map("reviewed_by") @db.Uuid
  reviewedAt             DateTime?          @map("reviewed_at")
  nextReverificationAt   DateTime?          @map("next_reverification_at")
  lastReverifiedAt       DateTime?          @map("last_reverified_at")
  submittedAt            DateTime           @default(now()) @map("submitted_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")

  @@index([status])
  @@index([vendorId])
  @@index([nextReverificationAt])
  @@map("vendor_verifications")
}

// Data Privacy - Export Requests
enum DataExportStatus {
  pending
  processing
  completed
  failed
  expired
}

model DataExportRequest {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String           @map("user_id") @db.Uuid
  status            DataExportStatus @default(pending)
  format            String           @default("json") // json, csv, or pdf
  categories        String[]         @default([]) // Specific data categories to export (empty = all)
  isRecurring       Boolean          @default(false) @map("is_recurring")
  recurringSchedule String?          @map("recurring_schedule") // cron expression for recurring exports
  nextRunAt         DateTime?        @map("next_run_at")
  downloadUrl       String?          @map("download_url")
  fileSize          Int?             @map("file_size")
  expiresAt         DateTime         @map("expires_at")
  completedAt       DateTime?        @map("completed_at")
  failedAt          DateTime?        @map("failed_at")
  failureReason     String?          @map("failure_reason")
  createdAt         DateTime         @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@index([isRecurring])
  @@index([nextRunAt])
  @@map("data_export_requests")
}

// Cron Job Monitoring
model CronJobExecution {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobName          String    @map("job_name")
  status           String // success, failed, running
  startedAt        DateTime  @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")
  duration         Int? // Duration in milliseconds
  recordsProcessed Int?      @map("records_processed")
  errorMessage     String?   @map("error_message")
  metadata         Json? // Additional job-specific data

  @@index([jobName])
  @@index([status])
  @@index([startedAt])
  @@map("cron_job_executions")
}

// Dispute Analytics
model DisputeAnalytics {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date                   DateTime @unique // Daily aggregation
  totalDisputes          Int      @default(0) @map("total_disputes")
  openDisputes           Int      @default(0) @map("open_disputes")
  resolvedDisputes       Int      @default(0) @map("resolved_disputes")
  avgResolutionTimeHours Float?   @map("avg_resolution_time_hours")
  disputesByType         Json     @map("disputes_by_type") // { not_received: 5, damaged: 3, ... }
  refundsProcessed       Int      @default(0) @map("refunds_processed")
  totalRefundAmount      Float    @default(0) @map("total_refund_amount")
  createdAt              DateTime @default(now()) @map("created_at")

  @@index([date])
  @@map("dispute_analytics")
}

// Email Marketing Campaigns
enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  paused
  cancelled
}

enum CampaignType {
  promotional
  transactional
  newsletter
  abandoned_cart
  welcome_series
  reengagement
}

model EmailCampaign {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  subject          String
  previewText      String?        @map("preview_text")
  htmlContent      String         @map("html_content")
  textContent      String         @map("text_content")
  type             CampaignType
  status           CampaignStatus @default(draft)
  templateId       String?        @map("template_id")
  segmentCriteria  Json?          @map("segment_criteria") // Targeting criteria
  scheduledFor     DateTime?      @map("scheduled_for")
  sentAt           DateTime?      @map("sent_at")
  createdBy        String         @map("created_by") @db.Uuid
  totalRecipients  Int            @default(0) @map("total_recipients")
  sentCount        Int            @default(0) @map("sent_count")
  openCount        Int            @default(0) @map("open_count")
  clickCount       Int            @default(0) @map("click_count")
  unsubscribeCount Int            @default(0) @map("unsubscribe_count")
  bounceCount      Int            @default(0) @map("bounce_count")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  @@index([status, scheduledFor])
  @@index([createdAt])
  @@map("email_campaigns")
}

model EmailTemplate {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  subject     String
  htmlContent String   @map("html_content")
  textContent String   @map("text_content")
  category    String // promotional, transactional, etc.
  variables   Json     @default("[]") // Available template variables
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

model EmailSubscription {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String
  userId         String?   @map("user_id") @db.Uuid
  isSubscribed   Boolean   @default(true) @map("is_subscribed")
  unsubscribedAt DateTime? @map("unsubscribed_at")
  preferences    Json      @default("{}") // Marketing preferences
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([email])
  @@index([userId])
  @@index([isSubscribed])
  @@map("email_subscriptions")
}

// ============================================
// Subscription Features
// ============================================

// Subscription Plan Types
enum SubscriptionPlanType {
  premium_monthly
  premium_yearly
  subscribe_save
}

// Subscription Status
enum SubscriptionStatus {
  active
  paused
  cancelled
  expired
  past_due
}

// Subscription Frequency for Subscribe & Save
enum SubscriptionFrequency {
  weekly
  biweekly
  monthly
  bimonthly
  quarterly
}

// Minalesh Premium Subscription
model PremiumSubscription {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String               @unique @map("user_id") @db.Uuid
  planType             SubscriptionPlanType @default(premium_monthly) @map("plan_type")
  status               SubscriptionStatus   @default(active)
  priceAmount          Decimal              @map("price_amount") @db.Decimal(10, 2)
  currency             String               @default("ETB")
  startDate            DateTime             @map("start_date")
  currentPeriodStart   DateTime             @map("current_period_start")
  currentPeriodEnd     DateTime             @map("current_period_end")
  cancelledAt          DateTime?            @map("cancelled_at")
  pausedAt             DateTime?            @map("paused_at")
  resumeAt             DateTime?            @map("resume_at")
  stripeSubscriptionId String?              @unique @map("stripe_subscription_id")
  paymentMethod        String?              @map("payment_method")
  autoRenew            Boolean              @default(true) @map("auto_renew")
  trialEndsAt          DateTime?            @map("trial_ends_at")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")

  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments SubscriptionPayment[]

  @@index([status])
  @@index([currentPeriodEnd])
  @@map("premium_subscriptions")
}

// Product Subscription (Subscribe & Save)
model ProductSubscription {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String                @map("user_id") @db.Uuid
  productId            String                @map("product_id") @db.Uuid
  variantId            String?               @map("variant_id") @db.Uuid
  quantity             Int                   @default(1)
  frequency            SubscriptionFrequency @default(monthly)
  status               SubscriptionStatus    @default(active)
  discountPercent      Decimal               @default(10) @map("discount_percent") @db.Decimal(5, 2)
  priceAtSubscription  Decimal               @map("price_at_subscription") @db.Decimal(10, 2)
  nextDeliveryDate     DateTime              @map("next_delivery_date")
  lastDeliveryDate     DateTime?             @map("last_delivery_date")
  shippingAddressId    String?               @map("shipping_address_id") @db.Uuid
  deliveryInstructions String?               @map("delivery_instructions")
  skippedDates         DateTime[]            @default([]) @map("skipped_dates")
  pausedAt             DateTime?             @map("paused_at")
  resumeAt             DateTime?             @map("resume_at")
  cancelledAt          DateTime?             @map("cancelled_at")
  cancellationReason   String?               @map("cancellation_reason")
  totalDeliveries      Int                   @default(0) @map("total_deliveries")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant?     @relation(fields: [variantId], references: [id], onDelete: SetNull)
  orders  SubscriptionOrder[]

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([nextDeliveryDate])
  @@map("product_subscriptions")
}

// Subscription Orders (links subscriptions to actual orders)
model SubscriptionOrder {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productSubscriptionId String   @map("product_subscription_id") @db.Uuid
  orderId               String   @map("order_id") @db.Uuid
  deliveryDate          DateTime @map("delivery_date")
  status                String   @default("pending") // pending, completed, failed, skipped
  createdAt             DateTime @default(now()) @map("created_at")

  subscription ProductSubscription @relation(fields: [productSubscriptionId], references: [id], onDelete: Cascade)
  order        Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([productSubscriptionId])
  @@index([orderId])
  @@map("subscription_orders")
}

// Subscription Payments
model SubscriptionPayment {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  premiumSubscriptionId String    @map("premium_subscription_id") @db.Uuid
  amount                Decimal   @db.Decimal(10, 2)
  currency              String    @default("ETB")
  status                String    @default("pending") // pending, completed, failed, refunded
  paymentMethod         String?   @map("payment_method")
  paymentReference      String?   @map("payment_reference")
  periodStart           DateTime  @map("period_start")
  periodEnd             DateTime  @map("period_end")
  paidAt                DateTime? @map("paid_at")
  failedAt              DateTime? @map("failed_at")
  failureReason         String?   @map("failure_reason")
  createdAt             DateTime  @default(now()) @map("created_at")

  subscription PremiumSubscription @relation(fields: [premiumSubscriptionId], references: [id], onDelete: Cascade)

  @@index([premiumSubscriptionId])
  @@index([status])
  @@map("subscription_payments")
}

// ============================================
// System Monitoring & Backup
// ============================================

// System Health Metrics
model SystemHealthMetric {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  metricType  String   @map("metric_type") // cpu, memory, disk, api_latency, error_rate, etc.
  metricValue Float    @map("metric_value")
  metricUnit  String?  @map("metric_unit")
  threshold   Float? // Alert threshold
  status      String   @default("healthy") // healthy, warning, critical
  metadata    Json? // Additional context
  recordedAt  DateTime @default(now()) @map("recorded_at")

  @@index([metricType])
  @@index([recordedAt])
  @@index([status])
  @@map("system_health_metrics")
}

// Backup Records
model BackupRecord {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  backupType    String    @map("backup_type") // full, incremental, differential
  status        String    @default("pending") // pending, in_progress, completed, failed
  size          BigInt? // Size in bytes
  location      String? // S3 URL or storage path
  encryptionKey String?   @map("encryption_key")
  checksum      String? // For integrity verification
  retentionDays Int       @default(30) @map("retention_days")
  expiresAt     DateTime  @map("expires_at")
  startedAt     DateTime  @default(now()) @map("started_at")
  completedAt   DateTime? @map("completed_at")
  errorMessage  String?   @map("error_message")
  metadata      Json? // Additional backup info

  @@index([backupType])
  @@index([status])
  @@index([expiresAt])
  @@map("backup_records")
}

// Alert Configuration
model AlertConfig {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  description     String?
  metricType      String    @map("metric_type")
  condition       String // gt, lt, eq, gte, lte
  threshold       Float
  severity        String    @default("warning") // info, warning, critical
  isEnabled       Boolean   @default(true) @map("is_enabled")
  cooldownMinutes Int       @default(15) @map("cooldown_minutes")
  notifyEmail     Boolean   @default(true) @map("notify_email")
  notifySlack     Boolean   @default(false) @map("notify_slack")
  webhookUrl      String?   @map("webhook_url")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  alerts AlertHistory[]

  @@index([metricType])
  @@index([isEnabled])
  @@map("alert_configs")
}

// Alert History
model AlertHistory {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  alertConfigId  String    @map("alert_config_id") @db.Uuid
  metricValue    Float     @map("metric_value")
  threshold      Float
  severity       String
  message        String
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime? @map("acknowledged_at")
  acknowledgedBy String?   @map("acknowledged_by") @db.Uuid
  resolvedAt     DateTime? @map("resolved_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  alertConfig AlertConfig @relation(fields: [alertConfigId], references: [id], onDelete: Cascade)

  @@index([alertConfigId])
  @@index([acknowledged])
  @@index([createdAt])
  @@map("alert_history")
}

// Feature Flags for CI/CD
model FeatureFlag {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique
  name        String
  description String?
  isEnabled   Boolean  @default(false) @map("is_enabled")
  percentage  Int?     @default(100) // For gradual rollout (0-100)
  targetUsers String[] @default([]) @map("target_users") // Specific user IDs
  targetRoles String[] @default([]) @map("target_roles") // customer, vendor, admin
  conditions  Json? // Complex conditions for targeting
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@index([isEnabled])
  @@map("feature_flags")
}

// Deployment Records
model DeploymentRecord {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  version         String
  environment     String // staging, production
  status          String    @default("pending") // pending, deploying, deployed, failed, rolled_back
  commitHash      String?   @map("commit_hash")
  commitMessage   String?   @map("commit_message")
  deployedBy      String?   @map("deployed_by")
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  rollbackOf      String?   @map("rollback_of") @db.Uuid // Reference to deployment being rolled back
  smokeTestPassed Boolean?  @map("smoke_test_passed")
  errorMessage    String?   @map("error_message")
  metadata        Json? // Build info, change list, etc.

  @@index([environment])
  @@index([status])
  @@index([startedAt])
  @@map("deployment_records")
}

// ============================================
// Price Alerts & Saved Searches
// ============================================

// Saved Search for users to save their favorite search queries
model SavedSearch {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String
  query     String
  filters   Json     @default("{}") // category, price range, rating, etc.
  notifyNew Boolean  @default(false) @map("notify_new") // Email digest of new matching products
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_searches")
}

// Price Alert for users to track price drops
model PriceAlert {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  productId   String    @map("product_id") @db.Uuid
  targetPrice Decimal   @map("target_price") @db.Decimal(10, 2)
  isActive    Boolean   @default(true) @map("is_active")
  triggered   Boolean   @default(false)
  triggeredAt DateTime? @map("triggered_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([isActive, triggered])
  @@map("price_alerts")
}

// ============================================
// Buyer Protection Program
// ============================================

// Protection Claim Type
enum ProtectionClaimType {
  not_received
  not_as_described
  auto_refund_sla // Automatic refund due to vendor not shipping within SLA
}

// Protection Claim Status
enum ProtectionClaimStatus {
  pending
  under_review
  approved
  rejected
  refunded
  cancelled
}

// Protection Claim for Buyer Protection Program
model ProtectionClaim {
  id                    String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId               String                @map("order_id") @db.Uuid
  userId                String                @map("user_id") @db.Uuid
  claimType             ProtectionClaimType   @map("claim_type")
  status                ProtectionClaimStatus @default(pending)
  description           String?
  evidenceUrls          String[]              @default([]) @map("evidence_urls")
  requestedRefundAmount Decimal               @map("requested_refund_amount") @db.Decimal(10, 2)
  approvedRefundAmount  Decimal?              @map("approved_refund_amount") @db.Decimal(10, 2)
  refundTransactionId   String?               @map("refund_transaction_id")
  resolution            String?
  reviewedBy            String?               @map("reviewed_by") @db.Uuid
  reviewedAt            DateTime?             @map("reviewed_at")
  refundedAt            DateTime?             @map("refunded_at")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("protection_claims")
}

// Buyer Protection Settings (global configuration)
model BuyerProtectionSettings {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  protectionFeePercent     Decimal  @default(2.5) @map("protection_fee_percent") @db.Decimal(5, 2) // 2-3%
  protectionPeriodDays     Int      @default(30) @map("protection_period_days")
  vendorShippingSLAHours   Int      @default(72) @map("vendor_shipping_sla_hours") // 72 hours (3 days)
  insuranceThresholdAmount Decimal  @default(5000) @map("insurance_threshold_amount") @db.Decimal(10, 2) // High-value threshold
  insuranceFeePercent      Decimal  @default(1.5) @map("insurance_fee_percent") @db.Decimal(5, 2)
  isEnabled                Boolean  @default(true) @map("is_enabled")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  @@map("buyer_protection_settings")
}

// ============================================
// Social Sharing
// ============================================

// Social platform enum
enum SharePlatform {
  whatsapp
  facebook
  twitter
  telegram
  copy_link
  qr_code
  native
}

// Product Share tracking
model ProductShare {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String        @map("product_id") @db.Uuid
  userId    String?       @map("user_id") @db.Uuid // Optional: track if user is logged in
  platform  SharePlatform
  userAgent String?       @map("user_agent") // Track device/browser
  ipAddress String?       @map("ip_address") // For analytics
  createdAt DateTime      @default(now()) @map("created_at")

  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    Profile? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([userId])
  @@index([platform])
  @@index([createdAt])
  @@map("product_shares")
}

// ============================================
// Security & DDoS Protection
// ============================================

// IP Whitelist - Known good IPs that bypass rate limiting
model IpWhitelist {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ipAddress String    @unique @map("ip_address")
  reason    String // Why this IP is whitelisted
  createdBy String?   @map("created_by") @db.Uuid // Admin who added it
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at") // Optional expiration
  isActive  Boolean   @default(true) @map("is_active")

  @@index([ipAddress])
  @@index([isActive])
  @@map("ip_whitelist")
}

// IP Blacklist - Abusive IPs that are blocked
model IpBlacklist {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ipAddress     String    @unique @map("ip_address")
  reason        String // Why this IP is blacklisted
  severity      String    @default("medium") // low, medium, high, critical
  createdBy     String?   @map("created_by") @db.Uuid // Admin who added it or "system" for auto-blacklist
  createdAt     DateTime  @default(now()) @map("created_at")
  expiresAt     DateTime? @map("expires_at") // Optional expiration for temporary bans
  isActive      Boolean   @default(true) @map("is_active")
  blockCount    Int       @default(0) @map("block_count") // How many requests blocked
  lastBlockedAt DateTime? @map("last_blocked_at")

  @@index([ipAddress])
  @@index([isActive])
  @@index([severity])
  @@map("ip_blacklist")
}

// Security Events - Track suspicious activity
model SecurityEvent {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ipAddress  String    @map("ip_address")
  eventType  String    @map("event_type") // rate_limit_exceeded, bot_detected, suspicious_pattern, etc.
  severity   String    @default("low") // low, medium, high, critical
  userAgent  String?   @map("user_agent")
  endpoint   String? // Which API endpoint was accessed
  metadata   Json? // Additional event data
  createdAt  DateTime  @default(now()) @map("created_at")
  resolved   Boolean   @default(false)
  resolvedAt DateTime? @map("resolved_at")
  resolvedBy String?   @map("resolved_by") @db.Uuid

  @@index([ipAddress])
  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
  @@index([resolved])
  @@map("security_events")
}

// ============================================
// Vendor Contract Management
// ============================================

// Contract Templates - Reusable contract templates by vendor type
model ContractTemplate {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  contractType ContractType @map("contract_type")
  version      String       @default("1.0")
  content      String       @db.Text // HTML/Markdown content of the contract
  variables    Json? // Variables that can be replaced in the template
  isActive     Boolean      @default(true) @map("is_active")
  createdBy    String?      @map("created_by") @db.Uuid // Admin who created it
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  contracts VendorContract[]

  @@index([contractType])
  @@index([isActive])
  @@map("contract_templates")
}

// Vendor Contracts - Main contract records
model VendorContract {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String         @map("vendor_id") @db.Uuid
  templateId       String?        @map("template_id") @db.Uuid
  contractNumber   String         @unique @map("contract_number") // Auto-generated contract number
  contractType     ContractType   @map("contract_type")
  status           ContractStatus @default(draft)
  version          Int            @default(1)
  parentContractId String?        @map("parent_contract_id") @db.Uuid // For versioning - links to previous version

  // Contract details
  title   String
  content String @db.Text // Final contract content

  // Terms
  startDate           DateTime @map("start_date")
  endDate             DateTime @map("end_date")
  autoRenew           Boolean  @default(false) @map("auto_renew")
  renewalPeriodMonths Int?     @map("renewal_period_months") // e.g., 12 for annual renewal

  // Commission and payment terms
  commissionRate Decimal @default(0.15) @map("commission_rate") @db.Decimal(5, 4)
  paymentTerms   String? @map("payment_terms") @db.Text

  // Document storage
  documentUrl String? @map("document_url") // S3 URL for signed PDF

  // Termination
  terminationDate   DateTime? @map("termination_date")
  terminationReason String?   @map("termination_reason") @db.Text
  terminatedBy      String?   @map("terminated_by") @db.Uuid

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  signedAt  DateTime? @map("signed_at")

  // Relations
  vendor         Profile             @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  template       ContractTemplate?   @relation(fields: [templateId], references: [id])
  parentContract VendorContract?     @relation("ContractVersions", fields: [parentContractId], references: [id])
  childContracts VendorContract[]    @relation("ContractVersions")
  signatures     ContractSignature[]

  @@index([vendorId])
  @@index([status])
  @@index([contractType])
  @@index([endDate])
  @@index([parentContractId])
  @@map("vendor_contracts")
}

// Contract Signatures - E-signature records
model ContractSignature {
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractId String          @map("contract_id") @db.Uuid
  signerId   String          @map("signer_id") @db.Uuid // User who signed
  signerRole String          @map("signer_role") // 'vendor' or 'admin'
  status     SignatureStatus @default(pending)

  // Signature details
  signatureData String? @map("signature_data") @db.Text // Base64 encoded signature image or text
  ipAddress     String? @map("ip_address")
  userAgent     String? @map("user_agent")

  // Rejection details (if applicable)
  rejectionReason String? @map("rejection_reason") @db.Text

  // Timestamps
  signedAt  DateTime? @map("signed_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  contract VendorContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([signerId])
  @@index([status])
  @@map("contract_signatures")
}

// Warehouse model for multi-origin delivery tracking
model Warehouse {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  code       String  @unique // Short code like "AA-01" for Addis Ababa Warehouse 1
  address    String
  city       String
  region     String?
  country    String  @default("Ethiopia")
  postalCode String? @map("postal_code")

  // GPS coordinates for map visualization
  latitude  Decimal @db.Decimal(10, 8)
  longitude Decimal @db.Decimal(11, 8)

  // Warehouse details
  phone       String?
  email       String?
  managerName String? @map("manager_name")
  capacity    Int? // Max items capacity

  // Operating hours (JSON format: {monday: {open: "08:00", close: "18:00"}, ...})
  operatingHours Json? @default("{}") @map("operating_hours")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  isPrimary Boolean @default(false) @map("is_primary") // Primary/default warehouse

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders             Order[]             @relation("WarehouseOrders")
  // New: Next-gen features
  inventoryForecasts InventoryForecast[]
  autoReorderRules   AutoReorderRule[]

  @@index([city])
  @@index([isActive])
  @@index([isPrimary])
  @@map("warehouses")
}

// ============================================
// NEXT-GENERATION E-COMMERCE FEATURES
// ============================================

// AI-Powered Recommendations
model RecommendationScore {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  productId   String   @db.Uuid
  score       Float // 0-1 recommendation confidence
  algorithm   String // collaborative, content_based, trending, hybrid
  factors     Json // Factors that influenced recommendation
  generatedAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, algorithm])
  @@index([userId, score])
  @@index([productId])
  @@index([generatedAt])
  @@map("recommendation_scores")
}

// Live Chat & Real-Time Support
enum ChatStatus {
  active
  archived
  closed
}

model ChatConversation {
  id            String     @id @default(uuid()) @db.Uuid
  customerId    String     @db.Uuid
  vendorId      String?    @db.Uuid
  adminId       String?    @db.Uuid
  productId     String?    @db.Uuid // Related product
  orderId       String?    @db.Uuid // Related order
  subject       String?
  status        ChatStatus @default(active)
  lastMessageAt DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  customer User          @relation("CustomerChats", fields: [customerId], references: [id], onDelete: Cascade)
  vendor   User?         @relation("VendorChats", fields: [vendorId], references: [id], onDelete: Cascade)
  admin    User?         @relation("AdminChats", fields: [adminId], references: [id], onDelete: Cascade)
  product  Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  order    Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)
  messages ChatMessage[]

  @@index([customerId])
  @@index([vendorId])
  @@index([adminId])
  @@index([status])
  @@index([lastMessageAt])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @db.Uuid
  senderId       String    @db.Uuid
  senderType     String // customer, vendor, admin, bot
  message        String    @db.Text
  attachments    String[] // URLs to images/files
  isRead         Boolean   @default(false)
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User             @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([isRead])
  @@map("chat_messages")
}

// Voice Search & Commands
model VoiceSearch {
  id            String   @id @default(uuid())
  userId        String?  @db.Uuid
  sessionId     String // Anonymous session tracking
  language      String // en, am, om
  audioUrl      String? // S3 URL to audio file
  transcription String // Text from speech
  intent        String? // search, navigate, command
  confidence    Float // 0-1 transcription confidence
  resultCount   Int      @default(0)
  createdAt     DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([language])
  @@index([createdAt])
  @@map("voice_searches")
}

// Social Commerce & Group Buying
enum GroupPurchaseStatus {
  active
  completed
  expired
  cancelled
}

enum EqubCircleStatus {
  active
  completed
  cancelled
}

enum EqubDistributionStatus {
  pending
  completed
  skipped
}

model GroupPurchase {
  id              String              @id @default(uuid()) @db.Uuid
  productId       String              @db.Uuid
  initiatorId     String              @db.Uuid
  title           String
  description     String?             @db.Text
  requiredMembers Int // Minimum members to activate
  currentMembers  Int                 @default(1)
  maxMembers      Int? // Optional max limit
  pricePerPerson  Float // Discounted price
  regularPrice    Float // Original price
  discount        Float // Discount percentage
  expiresAt       DateTime
  status          GroupPurchaseStatus @default(active)
  createdAt       DateTime            @default(now())
  completedAt     DateTime?

  product   Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  initiator User                  @relation("GroupPurchaseInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  members   GroupPurchaseMember[]

  @@index([productId])
  @@index([status])
  @@index([expiresAt])
  @@index([currentMembers])
  @@map("group_purchases")
}

model GroupPurchaseMember {
  id              String   @id @default(uuid()) @db.Uuid
  groupPurchaseId String   @db.Uuid
  userId          String   @db.Uuid
  isPaid          Boolean  @default(false)
  paidAmount      Float?
  orderId         String?  @db.Uuid
  joinedAt        DateTime @default(now())

  groupPurchase GroupPurchase @relation(fields: [groupPurchaseId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  order         Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@unique([groupPurchaseId, userId])
  @@index([userId])
  @@index([isPaid])
  @@map("group_purchase_members")
}

// Ethiopian Equb (Rotating Savings and Credit Association)
model EqubCircle {
  id                 String           @id @default(uuid()) @db.Uuid
  name               String
  description        String?          @db.Text
  creatorId          String           @db.Uuid
  memberLimit        Int // Maximum number of members
  contributionAmount Float // Amount each member contributes per round
  frequency          String // weekly, biweekly, monthly
  startDate          DateTime
  endDate            DateTime?
  currentRound       Int              @default(0)
  totalRounds        Int // Calculated: memberLimit
  status             EqubCircleStatus @default(active)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  creator       User               @relation("EqubCircleCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members       EqubCircleMember[]
  contributions EqubContribution[]
  distributions EqubDistribution[]

  @@index([creatorId])
  @@index([status])
  @@index([startDate])
  @@map("equb_circles")
}

model EqubCircleMember {
  id           String   @id @default(uuid()) @db.Uuid
  equbCircleId String   @db.Uuid
  userId       String   @db.Uuid
  position     Int // Distribution order (1-N)
  isActive     Boolean  @default(true)
  joinedAt     DateTime @default(now())

  equbCircle    EqubCircle         @relation(fields: [equbCircleId], references: [id], onDelete: Cascade)
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions EqubContribution[]

  @@unique([equbCircleId, userId])
  @@unique([equbCircleId, position])
  @@index([userId])
  @@map("equb_circle_members")
}

model EqubContribution {
  id           String   @id @default(uuid()) @db.Uuid
  equbCircleId String   @db.Uuid
  memberId     String   @db.Uuid
  round        Int
  amount       Float
  paidAt       DateTime @default(now())

  equbCircle EqubCircle       @relation(fields: [equbCircleId], references: [id], onDelete: Cascade)
  member     EqubCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([equbCircleId])
  @@index([memberId])
  @@index([round])
  @@map("equb_contributions")
}

model EqubDistribution {
  id            String                 @id @default(uuid()) @db.Uuid
  equbCircleId  String                 @db.Uuid
  recipientId   String                 @db.Uuid
  round         Int
  amount        Float
  status        EqubDistributionStatus @default(pending)
  scheduledDate DateTime
  distributedAt DateTime?

  equbCircle EqubCircle @relation(fields: [equbCircleId], references: [id], onDelete: Cascade)
  recipient  User       @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([equbCircleId])
  @@index([recipientId])
  @@index([round])
  @@index([status])
  @@map("equb_distributions")
}

model SocialShare {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  productId String    @db.Uuid
  platform  String // whatsapp, telegram, facebook, twitter, messenger
  shareCode String    @unique
  shareUrl  String
  views     Int       @default(0)
  clicks    Int       @default(0)
  purchases Int       @default(0)
  revenue   Float     @default(0)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([shareCode])
  @@index([platform])
  @@map("social_shares")
}

// Smart Inventory Forecasting
model InventoryForecast {
  id              String   @id @default(uuid()) @db.Uuid
  productId       String   @db.Uuid
  warehouseId     String?  @db.Uuid
  forecastDate    DateTime // Date for the forecast
  predictedDemand Float // Predicted units
  confidence      Float // 0-1 confidence score
  actualDemand    Float? // Filled after date passes
  accuracy        Float? // Calculated accuracy after fact
  factors         Json // Factors influencing forecast
  modelVersion    String // ML model version used
  createdAt       DateTime @default(now())

  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  @@unique([productId, warehouseId, forecastDate])
  @@index([forecastDate])
  @@index([confidence])
  @@map("inventory_forecasts")
}

model AutoReorderRule {
  id              String    @id @default(uuid()) @db.Uuid
  productId       String    @db.Uuid
  vendorId        String    @db.Uuid
  warehouseId     String?   @db.Uuid
  reorderPoint    Int // When to reorder
  reorderQuantity Int // How much to reorder
  leadTimeDays    Int // Supplier lead time
  safetyStock     Int // Buffer stock
  minOrderQty     Int? // Minimum order quantity
  maxOrderQty     Int? // Maximum order quantity
  isActive        Boolean   @default(true)
  lastTriggered   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendor    User       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  @@unique([productId, warehouseId])
  @@index([vendorId])
  @@index([isActive])
  @@map("auto_reorder_rules")
}

enum POStatus {
  draft
  pending_approval
  approved
  sent_to_supplier
  partially_received
  received
  cancelled
}

model PurchaseOrder {
  id               String    @id @default(uuid()) @db.Uuid
  poNumber         String    @unique // PO-2026-001
  vendorId         String    @db.Uuid
  supplierId       String    @db.Uuid // External supplier
  supplierName     String
  items            Json // Array of {productId, quantity, unitPrice}
  subtotal         Float
  taxAmount        Float     @default(0)
  totalAmount      Float
  status           POStatus  @default(draft)
  expectedDelivery DateTime
  actualDelivery   DateTime?
  autoGenerated    Boolean   @default(false)
  notes            String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  vendor User @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([status])
  @@index([expectedDelivery])
  @@map("purchase_orders")
}

// Gamification System
model UserAchievement {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @db.Uuid
  achievementKey  String // first_purchase, power_reviewer, etc.
  achievementName String
  description     String
  iconUrl         String?
  points          Int       @default(0)
  earnedAt        DateTime  @default(now())
  rewardClaimed   Boolean   @default(false)
  claimedAt       DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementKey])
  @@index([userId])
  @@index([earnedAt])
  @@map("user_achievements")
}

model DailyCheckIn {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  checkInDate DateTime @db.Date
  streakCount Int      @default(1)
  reward      Int // Points earned
  bonusReward Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, checkInDate])
  @@index([userId])
  @@index([checkInDate])
  @@map("daily_check_ins")
}

enum GameType {
  spin_wheel
  scratch_card
  quiz
  survey
  mini_game
}

model GameScore {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  gameType   GameType
  score      Int      @default(0)
  reward     Int // Points or discount earned
  rewardType String // points, discount_code, free_shipping
  metadata   Json? // Game-specific data
  playedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gameType])
  @@index([playedAt])
  @@map("game_scores")
}

// Enhanced Flash Sales
model FlashSaleRegistration {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @db.Uuid
  flashSaleId  String    @db.Uuid
  notified     Boolean   @default(false)
  notifiedAt   DateTime?
  purchased    Boolean   @default(false)
  registeredAt DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashSale FlashSale @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)

  @@unique([userId, flashSaleId])
  @@index([flashSaleId])
  @@index([notified])
  @@map("flash_sale_registrations")
}

// Live Stock Counter for Flash Sales
model LiveStockCounter {
  id            String   @id @default(uuid()) @db.Uuid
  productId     String   @db.Uuid
  flashSaleId   String?  @db.Uuid
  totalStock    Int
  soldCount     Int      @default(0)
  reservedCount Int      @default(0)
  viewCount     Int      @default(0)
  updatedAt     DateTime @updatedAt

  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  flashSale FlashSale? @relation(fields: [flashSaleId], references: [id], onDelete: SetNull)

  @@unique([productId, flashSaleId])
  @@index([productId])
  @@map("live_stock_counters")
}

// Beta Feedback System
model BetaFeedback {
  id          String           @id @default(uuid()) @db.Uuid
  userId      String?          @db.Uuid
  type        FeedbackType
  priority    FeedbackPriority @default(medium)
  status      FeedbackStatus   @default(new)
  title       String
  description String           @db.Text
  page        String?          // Page where feedback was submitted
  userAgent   String?          @db.Text
  metadata    Json?            // Additional context (browser info, etc.)
  screenshot  String?          // Optional screenshot URL
  email       String?          // For anonymous feedback
  adminNotes  String?          @db.Text
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([userId])
  @@index([createdAt])
  @@map("beta_feedback")
}

// Beta Program Enrollment
model BetaTester {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @unique @db.Uuid
  inviteCode       String?  @unique
  invitedBy        String?  @db.Uuid
  acceptedTerms    Boolean  @default(false)
  termsAcceptedAt  DateTime?
  notificationOptIn Boolean @default(true)
  active           Boolean  @default(true)
  enrolledAt       DateTime @default(now())
  lastActiveAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([enrolledAt])
  @@map("beta_testers")
}

// Feature Announcements
model FeatureAnnouncement {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  description String    @db.Text
  category    String?   // e.g., "new_feature", "improvement", "bug_fix"
  imageUrl    String?
  ctaText     String?   // Call to action text
  ctaUrl      String?   // Call to action URL
  priority    Int       @default(0) // Higher = more important
  publishedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  reads FeatureAnnouncementRead[]

  @@index([publishedAt])
  @@index([expiresAt])
  @@map("feature_announcements")
}

// Track which users have read announcements
model FeatureAnnouncementRead {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @db.Uuid
  announcementId String   @db.Uuid
  readAt         DateTime @default(now())

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  announcement FeatureAnnouncement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([userId, announcementId])
  @@index([userId])
  @@index([announcementId])
  @@map("feature_announcement_reads")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum OrderStatus {
  pending
  paid
  confirmed
  processing
  fulfilled
  shipped
  delivered
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum VendorStatus {
  pending
  approved
  rejected
  suspended
}

enum NotificationType {
  order
  payment
  vendor
  promotion
  system
}

enum DiscountType {
  percentage
  fixed_amount
  free_shipping
}

enum CouponStatus {
  active
  inactive
  expired
  depleted
}

enum PromotionType {
  product_discount
  category_discount
  cart_discount
  buy_x_get_y
}

enum UserRole {
  customer
  vendor
  admin
}

// Models
model User {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                 String    @unique
  password              String
  role                  UserRole  @default(customer)
  emailVerified         DateTime? @map("email_verified")
  emailVerificationToken String?  @map("email_verification_token")
  passwordResetToken    String?   @map("password_reset_token")
  passwordResetExpiry   DateTime? @map("password_reset_expiry")
  loginAttempts         Int       @default(0) @map("login_attempts")
  lockoutUntil          DateTime? @map("lockout_until")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  profile       Profile?
  orders        Order[]
  reviews       Review[]
  wishlists     Wishlist[]
  couponUsages  CouponUsage[]
  notificationPreferences NotificationPreference?
  preferences   UserPreferences?
  loyaltyAccount LoyaltyAccount?
  referralsGiven Referral[] @relation("Referrer")
  referralsReceived Referral[] @relation("Referee")
  giftCardsPurchased GiftCard[] @relation("GiftCardPurchaser")
  giftCardsReceived GiftCard[] @relation("GiftCardRecipient")
  sellerRatings SellerRating[]
  disputes      Dispute[]
  comparisons   ProductComparison[]

  @@map("users")
}

model Profile {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String        @unique @map("user_id") @db.Uuid
  displayName   String?       @map("display_name")
  firstName     String?       @map("first_name")
  lastName      String?       @map("last_name")
  phone         String?
  address       String?
  city          String?
  country       String?
  postalCode    String?       @map("postal_code")
  avatarUrl     String?       @map("avatar_url")
  bio           String?
  isVendor      Boolean       @default(false) @map("is_vendor")
  vendorStatus  VendorStatus  @default(pending) @map("vendor_status")
  tradeLicense  String?       @map("trade_license")
  tinNumber     String?       @map("tin_number")
  commissionRate Decimal?     @default(0.15) @map("commission_rate") @db.Decimal(5, 4)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  products      Product[]
  orderItems    OrderItem[]
  vendorPayouts VendorPayout[]
  vendorStatements VendorStatement[]
  addresses     Address[]
  sellerRatings SellerRating[]
  disputes      Dispute[]

  @@map("profiles")
}

model Address {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId   String   @map("profile_id") @db.Uuid
  label       String   // e.g., "Home", "Work", "Office"
  fullName    String   @map("full_name")
  phone       String
  addressLine1 String  @map("address_line1")
  addressLine2 String? @map("address_line2")
  city        String
  state       String?
  postalCode  String?  @map("postal_code")
  country     String   @default("ET")
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model Category {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String     @unique
  description String?
  imageUrl    String?    @map("image_url")
  parentId    String?    @map("parent_id") @db.Uuid
  sortOrder   Int        @default(0) @map("sort_order")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@map("categories")
}

model Product {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId           String            @map("vendor_id") @db.Uuid
  categoryId         String?           @map("category_id") @db.Uuid
  name               String
  slug               String            @unique
  brand              String?
  description        String?
  shortDescription   String?           @map("short_description")
  price              Decimal           @db.Decimal(10, 2)
  salePrice          Decimal?          @map("sale_price") @db.Decimal(10, 2)
  sku                String?           @unique
  stockQuantity      Int               @default(0) @map("stock_quantity")
  lowStockThreshold  Int               @default(5) @map("low_stock_threshold")
  weight             Decimal?          @db.Decimal(8, 2)
  dimensions         Json?
  images             Json              @default("[]")
  features           Json              @default("[]")
  specifications     Json              @default("{}")
  isDigital          Boolean           @default(false) @map("is_digital")
  isFeatured         Boolean           @default(false) @map("is_featured")
  isActive           Boolean           @default(true) @map("is_active")
  metaTitle          String?           @map("meta_title")
  metaDescription    String?           @map("meta_description")
  ratingAverage      Decimal           @default(0) @map("rating_average") @db.Decimal(3, 2)
  ratingCount        Int               @default(0) @map("rating_count")
  viewCount          Int               @default(0) @map("view_count")
  saleCount          Int               @default(0) @map("sale_count")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  vendor             Profile           @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  category           Category?         @relation(fields: [categoryId], references: [id])
  variants           ProductVariant[]
  carts              Cart[]
  orderItems         OrderItem[]
  reviews            Review[]
  wishlists          Wishlist[]
  tieredPricing      TieredPricing[]
  flashSales         FlashSale[]
  reservations       InventoryReservation[]
  media              Media[]

  @@map("products")
}

model ProductVariant {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String   @map("product_id") @db.Uuid
  name          String
  price         Decimal? @db.Decimal(10, 2)
  salePrice     Decimal? @map("sale_price") @db.Decimal(10, 2)
  sku           String?  @unique
  stockQuantity Int      @default(0) @map("stock_quantity")
  weight        Decimal? @db.Decimal(8, 2)
  dimensions    Json?
  attributes    Json     @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  carts         Cart[]
  orderItems    OrderItem[]
  reservations  InventoryReservation[]

  @@map("product_variants")
}

model Cart {
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?         @map("user_id") @db.Uuid
  sessionId  String?         @map("session_id")
  productId  String          @map("product_id") @db.Uuid
  variantId  String?         @map("variant_id") @db.Uuid
  quantity   Int             @default(1)
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  product    Product         @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("carts")
}

model Order {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String?       @map("user_id") @db.Uuid
  orderNumber       String        @unique @map("order_number")
  status            OrderStatus   @default(pending)
  paymentStatus     PaymentStatus @default(pending) @map("payment_status")
  paymentMethod     String?       @map("payment_method")
  paymentReference  String?       @map("payment_reference")
  stripeSessionId   String?       @map("stripe_session_id")
  subtotal          Decimal       @db.Decimal(10, 2)
  shippingAmount    Decimal       @default(0) @map("shipping_amount") @db.Decimal(10, 2)
  taxAmount         Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount    Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10, 2)
  currency          String        @default("ETB")
  shippingAddress   Json?         @map("shipping_address")
  billingAddress    Json?         @map("billing_address")
  notes             String?
  paidAt            DateTime?     @map("paid_at")
  confirmedAt       DateTime?     @map("confirmed_at")
  processingAt      DateTime?     @map("processing_at")
  fulfilledAt       DateTime?     @map("fulfilled_at")
  shippedAt         DateTime?     @map("shipped_at")
  deliveredAt       DateTime?     @map("delivered_at")
  cancelledAt       DateTime?     @map("cancelled_at")
  refundedAt        DateTime?     @map("refunded_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  user              User?           @relation(fields: [userId], references: [id])
  orderItems        OrderItem[]
  reviews           Review[]
  orderEvents       OrderEvent[]
  couponId          String?         @map("coupon_id") @db.Uuid
  coupon            Coupon?         @relation(fields: [couponId], references: [id])
  promotionIds      Json            @default("[]") @map("promotion_ids")
  shippingZoneId    String?         @map("shipping_zone_id") @db.Uuid
  shippingZone      ShippingZone?   @relation(fields: [shippingZoneId], references: [id])
  shippingMethodId  String?         @map("shipping_method_id") @db.Uuid
  shippingMethod    ShippingMethod? @relation(fields: [shippingMethodId], references: [id])
  couponUsages      CouponUsage[]
  refunds           Refund[]
  invoice           Invoice?
  giftCardTransactions GiftCardTransaction[]
  sellerRatings     SellerRating[]
  disputes          Dispute[]

  @@map("orders")
}

model OrderEvent {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String      @map("order_id") @db.Uuid
  eventType   String      @map("event_type")
  status      OrderStatus?
  description String?
  metadata    Json?
  createdAt   DateTime    @default(now()) @map("created_at")

  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_events")
}

model WebhookEvent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider    String
  eventId     String?  @map("event_id")
  orderId     String?  @map("order_id") @db.Uuid
  signature   String?
  signatureHash String? @map("signature_hash")
  payload     Json
  status      String   @default("received")
  createdAt   DateTime @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")
  ipAddress   String?  @map("ip_address")
  latencyMs   Int?      @map("latency_ms")
  errorMessage String?  @map("error_message")
  retryCount  Int       @default(0) @map("retry_count")
  nextRetryAt DateTime? @map("next_retry_at")
  archived    Boolean   @default(false)

  @@unique([provider, eventId])
  @@map("webhook_events")
}

model OrderItem {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String          @map("order_id") @db.Uuid
  vendorId    String          @map("vendor_id") @db.Uuid
  productId   String?         @map("product_id") @db.Uuid
  variantId   String?         @map("variant_id") @db.Uuid
  productName String          @map("product_name")
  productSku  String?         @map("product_sku")
  quantity    Int             @default(1)
  price       Decimal         @db.Decimal(10, 2)
  total       Decimal         @db.Decimal(10, 2)
  createdAt   DateTime        @default(now()) @map("created_at")

  order       Order           @relation(fields: [orderId], references: [id])
  vendor      Profile         @relation(fields: [vendorId], references: [id])
  product     Product?        @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model Review {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  productId    String   @map("product_id") @db.Uuid
  orderId      String?  @map("order_id") @db.Uuid
  rating       Int
  title        String?
  comment      String?
  images       Json     @default("[]")
  helpfulCount Int      @default(0) @map("helpful_count")
  isVerified   Boolean  @default(false) @map("is_verified")
  isApproved   Boolean  @default(true) @map("is_approved")
  reportCount  Int      @default(0) @map("report_count")
  reportedBy   Json     @default("[]") @map("reported_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id])
  product      Product  @relation(fields: [productId], references: [id])
  order        Order?   @relation(fields: [orderId], references: [id])

  @@map("reviews")
}

model Wishlist {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@map("wishlists")
}

model Notification {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  @@map("notifications")
}

model VendorPayout {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String    @map("vendor_id") @db.Uuid
  periodStart      DateTime  @map("period_start")
  periodEnd        DateTime  @map("period_end")
  totalSales       Decimal   @map("total_sales") @db.Decimal(10, 2)
  commissionRate   Decimal   @default(0.15) @map("commission_rate") @db.Decimal(5, 4)
  commissionAmount Decimal   @map("commission_amount") @db.Decimal(10, 2)
  payoutAmount     Decimal   @map("payout_amount") @db.Decimal(10, 2)
  status           String    @default("pending")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  vendor           Profile   @relation(fields: [vendorId], references: [id])
  statements       VendorStatement[]

  @@map("vendor_payouts")
}

model AnalyticsEvent {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  sessionId  String?  @map("session_id")
  eventType  String   @map("event_type")
  eventData  Json?    @map("event_data")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("analytics_events")
}

model Coupon {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code             String        @unique
  description      String?
  discountType     DiscountType  @map("discount_type")
  discountValue    Decimal       @map("discount_value") @db.Decimal(10, 2)
  minimumPurchase  Decimal?      @map("minimum_purchase") @db.Decimal(10, 2)
  maximumDiscount  Decimal?      @map("maximum_discount") @db.Decimal(10, 2)
  usageLimit       Int?          @map("usage_limit")
  usageCount       Int           @default(0) @map("usage_count")
  perUserLimit     Int?          @map("per_user_limit")
  startsAt         DateTime?     @map("starts_at")
  expiresAt        DateTime?     @map("expires_at")
  status           CouponStatus  @default(active)
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  orders           Order[]
  couponUsages     CouponUsage[]

  @@index([status])
  @@index([expiresAt])
  @@map("coupons")
}

model CouponUsage {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  couponId       String   @map("coupon_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  orderId        String   @map("order_id") @db.Uuid
  discountAmount Decimal  @map("discount_amount") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  coupon         Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user           User?    @relation(fields: [userId], references: [id])
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@map("coupon_usage")
}

model Promotion {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  description     String?
  promotionType   PromotionType @map("promotion_type")
  discountType    DiscountType  @map("discount_type")
  discountValue   Decimal       @map("discount_value") @db.Decimal(10, 2)
  productIds      Json          @default("[]") @map("product_ids")
  categoryIds     Json          @default("[]") @map("category_ids")
  minimumQuantity Int?          @map("minimum_quantity")
  minimumPurchase Decimal?      @map("minimum_purchase") @db.Decimal(10, 2)
  buyQuantity     Int?          @map("buy_quantity")
  getQuantity     Int?          @map("get_quantity")
  isActive        Boolean       @default(true) @map("is_active")
  startsAt        DateTime      @map("starts_at")
  endsAt          DateTime?     @map("ends_at")
  priority        Int           @default(0)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([startsAt, endsAt])
  @@map("promotions")
}

model TieredPricing {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String       @map("product_id") @db.Uuid
  minQuantity   Int          @map("min_quantity")
  maxQuantity   Int?         @map("max_quantity")
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  product       Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("tiered_pricing")
}

model FlashSale {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  description   String?
  productId     String       @map("product_id") @db.Uuid
  discountType  DiscountType @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  originalPrice Decimal      @map("original_price") @db.Decimal(10, 2)
  flashPrice    Decimal      @map("flash_price") @db.Decimal(10, 2)
  stockLimit    Int?         @map("stock_limit")
  stockSold     Int          @default(0) @map("stock_sold")
  startsAt      DateTime     @map("starts_at")
  endsAt        DateTime     @map("ends_at")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  product       Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([startsAt, endsAt])
  @@map("flash_sales")
}

model ShippingZone {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  countries   Json     @default("[\"ET\"]")
  regions     Json     @default("[]")
  cities      Json     @default("[]")
  postalCodes Json     @default("[]") @map("postal_codes")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  shippingRates ShippingRate[]
  orders        Order[]

  @@map("shipping_zones")
}

model ShippingMethod {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  description       String?
  carrier           String?
  estimatedDaysMin  Int?     @map("estimated_days_min")
  estimatedDaysMax  Int?     @map("estimated_days_max")
  isActive          Boolean  @default(true) @map("is_active")
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  shippingRates     ShippingRate[]
  orders            Order[]

  @@map("shipping_methods")
}

model ShippingRate {
  id                     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  zoneId                 String         @map("zone_id") @db.Uuid
  methodId               String         @map("method_id") @db.Uuid
  baseRate               Decimal        @map("base_rate") @db.Decimal(10, 2)
  perKgRate              Decimal?       @map("per_kg_rate") @db.Decimal(10, 2)
  freeShippingThreshold  Decimal?       @map("free_shipping_threshold") @db.Decimal(10, 2)
  minOrderAmount         Decimal?       @map("min_order_amount") @db.Decimal(10, 2)
  maxOrderAmount         Decimal?       @map("max_order_amount") @db.Decimal(10, 2)
  isActive               Boolean        @default(true) @map("is_active")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")

  zone                   ShippingZone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  method                 ShippingMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)

  @@index([zoneId, methodId])
  @@map("shipping_rates")
}

model TaxRate {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  rate        Decimal  @db.Decimal(5, 4)
  country     String   @default("ET")
  region      String?
  city        String?
  taxType     String   @default("VAT") @map("tax_type")
  isCompound  Boolean  @default(false) @map("is_compound")
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([country, region, city])
  @@index([isActive])
  @@map("tax_rates")
}

model InventoryReservation {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId   String    @map("product_id") @db.Uuid
  variantId   String?   @map("variant_id") @db.Uuid
  quantity    Int
  userId      String?   @map("user_id") @db.Uuid
  sessionId   String?   @map("session_id")
  orderId     String?   @map("order_id") @db.Uuid
  status      String    @default("active")
  expiresAt   DateTime  @map("expires_at")
  releasedAt  DateTime? @map("released_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  product     Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([userId])
  @@index([sessionId])
  @@index([orderId])
  @@index([status, expiresAt])
  @@map("inventory_reservations")
}

model Refund {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId         String    @map("order_id") @db.Uuid
  amount          Decimal   @db.Decimal(10, 2)
  reason          String?
  status          String    @default("pending")
  provider        String?
  providerRefundId String?  @map("provider_refund_id")
  processedAt     DateTime? @map("processed_at")
  failedAt        DateTime? @map("failed_at")
  failureReason   String?   @map("failure_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("refunds")
}

model Invoice {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId         String    @unique @map("order_id") @db.Uuid
  invoiceNumber   String    @unique @map("invoice_number")
  issueDate       DateTime  @map("issue_date")
  dueDate         DateTime? @map("due_date")
  subtotal        Decimal   @db.Decimal(10, 2)
  taxAmount       Decimal   @db.Decimal(10, 2) @map("tax_amount")
  discountAmount  Decimal   @default(0) @db.Decimal(10, 2) @map("discount_amount")
  shippingAmount  Decimal   @default(0) @db.Decimal(10, 2) @map("shipping_amount")
  totalAmount     Decimal   @db.Decimal(10, 2) @map("total_amount")
  currency        String    @default("ETB")
  status          String    @default("draft")
  pdfUrl          String?   @map("pdf_url")
  emailSentAt     DateTime? @map("email_sent_at")
  paidAt          DateTime? @map("paid_at")
  notes           String?
  tinNumber       String?   @map("tin_number")
  tradeLicense    String?   @map("trade_license")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

model VendorStatement {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String   @map("vendor_id") @db.Uuid
  payoutId         String?  @map("payout_id") @db.Uuid
  statementNumber  String   @unique @map("statement_number")
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  totalSales       Decimal  @map("total_sales") @db.Decimal(10, 2)
  commissionAmount Decimal  @map("commission_amount") @db.Decimal(10, 2)
  payoutAmount     Decimal  @map("payout_amount") @db.Decimal(10, 2)
  pdfUrl           String?  @map("pdf_url")
  emailSentAt      DateTime? @map("email_sent_at")
  createdAt        DateTime @default(now()) @map("created_at")

  vendor           Profile       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  payout           VendorPayout? @relation(fields: [payoutId], references: [id])

  @@index([vendorId])
  @@index([payoutId])
  @@map("vendor_statements")
}

model Media {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId        String   @map("product_id") @db.Uuid
  url              String
  altText          String?  @map("alt_text")
  size             Int
  width            Int?
  height           Int?
  format           String
  optimizedVersions Json    @default("{}") @map("optimized_versions")
  sortOrder        Int      @default(0) @map("sort_order")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("media")
}

model NotificationPreference {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @unique @map("user_id") @db.Uuid
  emailOrderConfirm     Boolean  @default(true) @map("email_order_confirm")
  emailShippingUpdate   Boolean  @default(true) @map("email_shipping_update")
  emailPromotions       Boolean  @default(false) @map("email_promotions")
  emailNewsletter       Boolean  @default(false) @map("email_newsletter")
  inAppOrderUpdates     Boolean  @default(true) @map("inapp_order_updates")
  inAppPromotions       Boolean  @default(true) @map("inapp_promotions")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model EmailQueue {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  to            String
  subject       String
  html          String
  text          String
  template      String?
  metadata      Json?
  status        String    @default("pending") // pending, processing, sent, failed
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  lastError     String?   @map("last_error")
  lastAttemptAt DateTime? @map("last_attempt_at")
  sentAt        DateTime? @map("sent_at")
  scheduledFor  DateTime? @map("scheduled_for")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([status, scheduledFor])
  @@index([createdAt])
  @@map("email_queue")
}

model CommissionLedger {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId         String   @map("vendor_id") @db.Uuid
  orderId          String   @map("order_id") @db.Uuid
  orderItemId      String?  @map("order_item_id") @db.Uuid
  saleAmount       Decimal  @map("sale_amount") @db.Decimal(10, 2)
  commissionRate   Decimal  @map("commission_rate") @db.Decimal(5, 4)
  commissionAmount Decimal  @map("commission_amount") @db.Decimal(10, 2)
  vendorPayout     Decimal  @map("vendor_payout") @db.Decimal(10, 2)
  status           String   @default("pending")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([vendorId])
  @@index([orderId])
  @@index([status])
  @@index([paidAt])
  @@map("commission_ledger")
}

model SiteSettings {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  maintenanceMode      Boolean  @default(false) @map("maintenance_mode")
  maintenanceMessage   String?  @map("maintenance_message")
  featuredProducts     Json?    @map("featured_products")
  homepageBanners      Json?    @map("homepage_banners")
  announcementBar      Json?    @map("announcement_bar")
  allowNewVendors      Boolean  @default(true) @map("allow_new_vendors")
  allowNewCustomers    Boolean  @default(true) @map("allow_new_customers")
  minOrderAmount       Decimal  @default(0) @map("min_order_amount") @db.Decimal(10, 2)
  maxOrderAmount       Decimal  @default(1000000) @map("max_order_amount") @db.Decimal(10, 2)
  defaultCurrency      String   @default("ETB") @map("default_currency")
  defaultLanguage      String   @default("en") @map("default_language")
  taxRate              Decimal  @default(0.15) @map("tax_rate") @db.Decimal(5, 4)
  shippingEnabled      Boolean  @default(true) @map("shipping_enabled")
  emailNotifications   Boolean  @default(true) @map("email_notifications")
  smsNotifications     Boolean  @default(false) @map("sms_notifications")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

// User Preferences for language and other settings
model UserPreferences {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @map("user_id") @db.Uuid
  language        String   @default("en")
  currency        String   @default("ETB")
  emailMarketing  Boolean  @default(true) @map("email_marketing")
  smsMarketing    Boolean  @default(false) @map("sms_marketing")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// Loyalty Program
enum LoyaltyTier {
  bronze
  silver
  gold
  platinum
}

model LoyaltyAccount {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @map("user_id") @db.Uuid
  points          Int      @default(0)
  lifetimePoints  Int      @default(0) @map("lifetime_points")
  tier            LoyaltyTier @default(bronze)
  nextTierPoints  Int      @default(1000) @map("next_tier_points")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    LoyaltyTransaction[]

  @@map("loyalty_accounts")
}

model LoyaltyTransaction {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId   String   @map("account_id") @db.Uuid
  points      Int      // positive for earn, negative for redeem
  type        String   // purchase, review, referral, redeem, bonus
  description String
  relatedId   String?  @map("related_id") @db.Uuid // orderId, reviewId, etc.
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")

  account     LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([createdAt])
  @@map("loyalty_transactions")
}

// Referral Program
enum ReferralStatus {
  pending
  registered
  completed
  expired
}

model Referral {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  referrerId  String   @map("referrer_id") @db.Uuid
  refereeId   String?  @map("referee_id") @db.Uuid
  code        String   @unique
  status      ReferralStatus @default(pending)
  rewardIssued Boolean @default(false) @map("reward_issued")
  createdAt   DateTime @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")
  expiresAt   DateTime @map("expires_at")

  referrer    User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee     User?    @relation("Referee", fields: [refereeId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([referrerId])
  @@index([status])
  @@map("referrals")
}

// Gift Cards
enum GiftCardStatus {
  active
  redeemed
  expired
  cancelled
}

model GiftCard {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String   @unique
  purchaserId  String   @map("purchaser_id") @db.Uuid
  recipientId  String?  @map("recipient_id") @db.Uuid
  recipientEmail String? @map("recipient_email")
  amount       Decimal  @db.Decimal(10, 2)
  balance      Decimal  @db.Decimal(10, 2)
  status       GiftCardStatus @default(active)
  message      String?
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  redeemedAt   DateTime? @map("redeemed_at")

  purchaser    User     @relation("GiftCardPurchaser", fields: [purchaserId], references: [id], onDelete: Cascade)
  recipient    User?    @relation("GiftCardRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  transactions GiftCardTransaction[]

  @@index([code])
  @@index([status])
  @@map("gift_cards")
}

model GiftCardTransaction {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cardId     String   @map("card_id") @db.Uuid
  orderId    String?  @map("order_id") @db.Uuid
  amount     Decimal  @db.Decimal(10, 2)
  type       String   // purchase, redeem, refund
  createdAt  DateTime @default(now()) @map("created_at")

  card       GiftCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  order      Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([cardId])
  @@map("gift_card_transactions")
}

// Seller Ratings
model SellerRating {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId          String   @map("vendor_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  orderId           String   @map("order_id") @db.Uuid
  communication     Int      // 1-5
  shippingSpeed     Int      @map("shipping_speed") // 1-5
  accuracy          Int      // 1-5
  customerService   Int      @map("customer_service") // 1-5
  overallRating     Decimal  @map("overall_rating") @db.Decimal(3, 2) // calculated average
  comment           String?
  createdAt         DateTime @default(now()) @map("created_at")

  vendor            Profile  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, userId])
  @@index([vendorId])
  @@map("seller_ratings")
}

// Dispute Resolution
enum DisputeType {
  not_received
  not_as_described
  damaged
  wrong_item
  refund_issue
  other
}

enum DisputeStatus {
  open
  pending_vendor_response
  pending_admin_review
  resolved
  closed
}

model Dispute {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String        @map("order_id") @db.Uuid
  userId        String        @map("user_id") @db.Uuid
  vendorId      String        @map("vendor_id") @db.Uuid
  type          DisputeType
  description   String
  evidenceUrls  String[]      @map("evidence_urls")
  status        DisputeStatus @default(open)
  resolution    String?
  resolvedBy    String?       @map("resolved_by") @db.Uuid
  resolvedAt    DateTime?     @map("resolved_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor        Profile       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  messages      DisputeMessage[]

  @@index([status])
  @@index([userId])
  @@index([vendorId])
  @@map("disputes")
}

model DisputeMessage {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  disputeId  String   @map("dispute_id") @db.Uuid
  senderId   String   @map("sender_id") @db.Uuid
  message    String
  isAdmin    Boolean  @default(false) @map("is_admin")
  createdAt  DateTime @default(now()) @map("created_at")

  dispute    Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@map("dispute_messages")
}

// Product Comparison
model ProductComparison {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  productIds String[] @map("product_ids") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("product_comparisons")
}

// Vendor Verification System
enum VerificationStatus {
  pending
  under_review
  approved
  rejected
  suspended
}

model VendorVerification {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  vendorId              String              @unique @map("vendor_id") @db.Uuid
  tradeLicenseUrl       String?             @map("trade_license_url")
  tradeLicenseNumber    String?             @map("trade_license_number")
  tinCertificateUrl     String?             @map("tin_certificate_url")
  tinNumber             String?             @map("tin_number")
  businessRegUrl        String?             @map("business_reg_url")
  ownerIdUrl            String?             @map("owner_id_url")
  status                VerificationStatus  @default(pending)
  rejectionReason       String?             @map("rejection_reason")
  reviewedBy            String?             @map("reviewed_by") @db.Uuid
  reviewedAt            DateTime?           @map("reviewed_at")
  submittedAt           DateTime            @default(now()) @map("submitted_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@index([status])
  @@index([vendorId])
  @@map("vendor_verifications")
}

// Data Privacy - Export Requests
enum DataExportStatus {
  pending
  processing
  completed
  failed
  expired
}

model DataExportRequest {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String            @map("user_id") @db.Uuid
  status        DataExportStatus  @default(pending)
  format        String            @default("json") // json or csv
  downloadUrl   String?           @map("download_url")
  fileSize      Int?              @map("file_size")
  expiresAt     DateTime          @map("expires_at")
  completedAt   DateTime?         @map("completed_at")
  failedAt      DateTime?         @map("failed_at")
  failureReason String?           @map("failure_reason")
  createdAt     DateTime          @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("data_export_requests")
}
